name: Daily Build

on:
  schedule:
    - cron: 0 20 * * *
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Initialization environment
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          sudo ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime

      - name: Set Python environment
        uses: actions/setup-python@v2
        with:
          python-version: '3.x'
          architecture: 'x64'

      - name: Clone mmdb_china_ip_list
        env:
          REPO_URL: https://github.com/alecthw/chnlist
          REPO_BRANCH: main
        run: |
          git clone -b $REPO_BRANCH $REPO_URL

      - name: Prepare Dir
        run: |
          mkdir -p chnlist/data

      - name: Clone domain-list-community
        env:
          REPO_URL: https://github.com/v2fly/domain-list-community
          REPO_BRANCH: master
        run: |
          git clone -b $REPO_BRANCH $REPO_URL
          mv -f domain-list-community/data chnlist/data/geosite

      - name: Clone ACL4SSR
        env:
          REPO_URL: https://github.com/ACL4SSR/ACL4SSR
          REPO_BRANCH: master
        run: |
          git clone -b $REPO_BRANCH $REPO_URL
          mv -f ACL4SSR/Clash chnlist/data/acl4ssr
          cp -rf chnlist/clash chnlist/data/acl4ssr/Custom

      - name: Generate dnsmasq file
        run: |
          cd chnlist
          python main.py

      - name: Prepare publish
        run: |
          cp -af chnlist/publish publish

      - name: Push to release branch
        run: |
          cd publish
          git init
          git config --local user.name "${{ github.actor }}"
          git config --local user.email "${{ github.actor }}@users.noreply.github.com"
          git checkout -b release
          git add .
          git commit -m "upload to release"
          git remote add origin "https://${{ github.actor }}:${{ secrets.PERSONAL_TOKEN }}@github.com/${{ github.repository }}"
          git push -f -u origin release

      - name: Clean jsdelivr cache
        run: |
          curl -skL https://purge.jsdelivr.net/gh/alecthw/chnlist@release/Providers/Custom/AllowProxy.yaml
          curl -skL https://purge.jsdelivr.net/gh/alecthw/chnlist@release/Providers/LocalAreaNetwork.yaml
          curl -skL https://purge.jsdelivr.net/gh/alecthw/chnlist@release/Providers/Custom/Direct.yaml
          curl -skL https://purge.jsdelivr.net/gh/alecthw/chnlist@release/Providers/Custom/Proxy.yaml
          curl -skL https://purge.jsdelivr.net/gh/alecthw/chnlist@release/Providers/UnBan.yaml
          curl -skL https://purge.jsdelivr.net/gh/alecthw/chnlist@release/Providers/BanAD.yaml
          curl -skL https://purge.jsdelivr.net/gh/alecthw/chnlist@release/Providers/BanProgramAD.yaml
          curl -skL https://purge.jsdelivr.net/gh/alecthw/chnlist@release/Providers/Ruleset/DisneyPlus.yaml
          curl -skL https://purge.jsdelivr.net/gh/alecthw/chnlist@release/Providers/Ruleset/Netflix.yaml
          curl -skL https://purge.jsdelivr.net/gh/alecthw/chnlist@release/Providers/Ruleset/NetflixIP.yaml
          curl -skL https://purge.jsdelivr.net/gh/alecthw/chnlist@release/Providers/ProxyMedia.yaml
          curl -skL https://purge.jsdelivr.net/gh/alecthw/chnlist@release/Providers/Download.yaml
          curl -skL https://purge.jsdelivr.net/gh/alecthw/chnlist@release/Providers/Ruleset/Telegram.yaml
          curl -skL https://purge.jsdelivr.net/gh/lhie1/Rules@master/Clash/Provider/Speedtest.yaml
          curl -skL https://purge.jsdelivr.net/gh/lhie1/Rules@master/Clash/Provider/PayPal.yaml
          curl -skL https://purge.jsdelivr.net/gh/alecthw/chnlist@release/Providers/Ruleset/Steam.yaml
          curl -skL https://purge.jsdelivr.net/gh/alecthw/chnlist@release/Providers/Ruleset/Xbox.yaml
          curl -skL https://purge.jsdelivr.net/gh/alecthw/chnlist@release/Providers/Ruleset/Microsoft.yaml
          curl -skL https://purge.jsdelivr.net/gh/alecthw/chnlist@release/Providers/ProxyLite.yaml
          curl -skL https://purge.jsdelivr.net/gh/alecthw/chnlist@release/Providers/ChinaDomain.yaml
          curl -skL https://purge.jsdelivr.net/gh/alecthw/chnlist@release/Providers/ChinaCompanyIp.yaml
